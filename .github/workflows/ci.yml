name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black ruff pytest
        pip install -r requirements.txt
    
    - name: Run black
      run: black --check src/ scripts/ tests/ demo/
    
    - name: Run ruff
      run: ruff check src/ scripts/ tests/ demo/
    
    - name: Run type checking
      run: |
        pip install mypy
        mypy src/ --ignore-missing-imports

  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        pytest tests/ -v --cov=src --cov-report=xml
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  inference-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test model creation and inference
      run: |
        python -c "
        import sys
        sys.path.append('src')
        from src.models.crnn import CRNNModel
        from src.features.melspectrogram import MelSpectrogramExtractor
        import torch
        
        # Test model creation
        model = CRNNModel(num_classes=10)
        extractor = MelSpectrogramExtractor()
        
        # Test inference
        dummy_audio = torch.randn(1, 22050)  # 1 second of audio
        features = extractor(dummy_audio)
        logits = model(features)
        
        print(f'Model created successfully')
        print(f'Input shape: {dummy_audio.shape}')
        print(f'Features shape: {features.shape}')
        print(f'Output shape: {logits.shape}')
        print('Inference test passed!')
        "
    
    - name: Test demo app import
      run: |
        python -c "
        import sys
        sys.path.append('demo')
        try:
            import streamlit_app
            print('Demo app imports successfully')
        except ImportError as e:
            print(f'Demo app import failed: {e}')
            exit(1)
        "

  build-docs:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install sphinx sphinx-rtd-theme
    
    - name: Build documentation
      run: |
        # Create basic documentation structure if it doesn't exist
        mkdir -p docs
        echo "# Environmental Sound Classification" > docs/README.md
        echo "Documentation for the environmental sound classification project." >> docs/README.md
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
